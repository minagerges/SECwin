
rem=process started another instance of itself
type=Single 
ptype=RegExp 
pattern=ProcessStarted_Image=\[(.*)\]_Hash=\[(.*)\]_Parent=\[(.*)\]
context=PROCESS_SHA1=62952E85C608B68EDE624F1F1C3AB6BB0CD6B092 || PROCESS_SHA1=4CB74DC73887907F1EFD67CF6690DD037D88F95D
desc=TRUSTED Process $1 started by $3 [HASH:$2]
rem= TRUSTED processes hashes to avoid dead loop (Perl & SigCheck)
action=none

type=Single 
ptype=RegExp 
pattern=ProcessStarted_Image=\[(.*)\]_Hash=\[(.*)\]_Parent=\[(.*)\]
context=PROCESS_$2 && !PROCESS_SHA1=62952E85C608B68EDE624F1F1C3AB6BB0CD6B092 && !PROCESS_SHA1=4CB74DC73887907F1EFD67CF6690DD037D88F95D
desc=Process [$1] started by [$3] [HASH:$2]
continue=takenext
action=create HASH_$2_IMAGE_$1 300

rem=Must use Hash value in context, only for started processes
type=Single
ptype=RegExp
pattern=ProcessStarted_Image=\[(.*)\]_Hash=\[(.*)\]_Parent=\[(.*)\]
context=HASH_$2_IMAGE_$3 && !SCANNED_$2
desc=<<Maliciouse Activity>> Process [$3] forked itself as [$1] [Hash:$2]
action=logonly; cspawn FileSigChecked sigcheck -q -c -vs "$1"; create SCANNED_$2 86400

rem=Scan all started processes, not necessary
type=single
ptype=RegExp
pattern=ProcessStarted_Image=\[(.*)\]_Hash=\[(.*)\]_Parent=\[(.*)\]
context=!SCANNED_$1
desc=Scanning ALL starting processes, Process [$1] started by [$3]  [HASH:$2]
rem=must return csv
action=logonly; cspawn FileSigChecked sigcheck -q -c -vs "$1"; create SCANNED_$2 86400

type=jump
ptype=perlfunc2
context=FileSigChecked
pattern=sub {	if ( $_[0] !~ /Path,Verified,Date,Publisher/) { return 0; } \
				my(%hash); @fields = split(',', $_[0]); @values = split('","', $_[1]);\
				@hash{@fields} = @values;\
				foreach $key (keys \%hash) { \
					$keyns = $key; $keyns=~ s/ /_/g; $keyns =~ s/\r//g; \
					$hash{$keyns} = $hash{$key}; } \
				$hash{"Path"} = substr($hash{"Path"}, 1); chop($hash{"VT_link"}); \
				return \%hash; }
varmap=SigCheck_VThashtable
desc=Parse SigCheck csv output to hashtable
cfset=SIGCHECK


type=Single
ptype=RegExp
pattern=ImageLoaded_Image=\[(.*)\]_Hash=\[(.*)\]_ImageLoaded=\[(.*)\]_Signed=false
context=HASH_$2_IMAGE_$3 && !SCANNED_$3
desc=<<Suspicious Activity>> Unsigned library [$3] LoadedBy [$1] [Hash:$2]
action=logonly; cspawn FileSigChecked sigcheck -q -c -vs "$3"; create SCANNED_$3 86400

type=Single
ptype=RegExp
pattern=RawAccessRead_Image=\[(.*)\]_PID=\[(.*)\]_Device=\[(.*)\]
context=!SCANNED_$1
desc=<<Suspicious Activity>> RAW DISK ACCESS READ from process [$1] PID:[$2] Device:[$3]
action=logonly; cspawn FileSigChecked sigcheck -q -c -vs "$1"; create SCANNED_$1 86400

rem=RansomWare, Change count and time periods
type=SingleWithThreshold 
ptype=RegExp 
pattern=ObjectAccess_WriteData_HandleID=\[(.*)\]_ProcessName=\[(.*)\]_ObjectName=\[(.*)\]_User=\[(.*)\]
desc=<<Suspected RansomWare>> Many DataWrite by process $2 within very shorttime
action=logonly; create SuspectedRansomeWare 300; event SuspectedRansomeWare_$2 ; cspawn FileSigChecked sigcheck -q -c -vs "$2"; create SCANNED_$2 86400
thresh=5
window=3

type=SingleWithThreshold 
ptype=RegExp 
pattern=ObjectDeleted_HandleID=\[(.*)\]_ProcessName=\[(.*)\]_User=\[(.*)\]
desc=<<Suspected RansomWare>> Many ObjectDelete by process $2 within very shorttime
action=logonly; create SuspectedRansomeWare 300; event SuspectedRansomeWare_$2 ; cspawn FileSigChecked sigcheck -q -c -vs "$2"; create SCANNED_$2 86400
thresh=5
window=3

rem=Unsigned DriverLoaded
type=single
ptype=RegExp
pattern=Driver_Loaded_Signed=\[false\]_ImageLoaded=\[(.*)\]_Hash=\[(.*)\]
context=DriverLoaded_$2
desc=<<URGENT Suspeciouse incident>> Unsigned driver loaded ImageLoaded:$1 Hash:$2
action=logonly;

rem= Port Scan
type=SingleWithThreshold 
ptype=RegExp 
pattern=NetworkConnectionActivity_Image=\[(.*)\]_IsInitiated=\[false\]_Protocol=\[(.*)\]_SRCIP=\[(.*)\]_DSTIP=\[(.*)\]_DSTport=\[(.*)\]_DSTportName=\[(.*)\]
desc=Five UnInitiated connection from $3
action=event 5_UNINITIATED_CONNECTIONS_PORT_$5_FROM_$3; create UNINITIATED_CONNECTIONS_SRC_$3 
window=60 
thresh=5

type=EventGroup 
init=create UNINITIATED_CONNECTION_COUNTING 
end=delete UNINITIATED_CONNECTION_COUNTING 
ptype=RegExp 
pattern=5_UNINITIATED_CONNECTIONS_PORT_(\d+)_FROM_(.*)
context=!UNINITIATED_CONNECTION_$2_COUNTED 
count=alias UNINITIATED_CONNECTION_COUNTING UNINITIATED_CONNECTION_$2_COUNTED 
desc=Repeated UnInitiated connection from $2 for 20 distinct ports within 1 minute
action=logonly 
window=60 
thresh=20

